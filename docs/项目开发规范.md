## 项目开发规范

本规范用于指导 AutoSwapEng Android 端的日常开发、协作与发布，确保代码一致性、可维护性与可扩展性。适用于所有贡献者（含临时/外部贡献者）。

### 适用范围
- **代码层面**: Kotlin、Jetpack Compose、无障碍服务、OCR、前台服务、资源与配置。
- **流程层面**: 分支策略、提交与评审、版本与发布、文档与问题跟踪。

---

## 1. 目录与分层

推荐包结构（与现有代码保持一致，可按需扩展）：
- `accessibility/`: 无障碍服务、节点工具、屏幕截取
- `ocr/`: OCR 引擎、屏幕区域定义
- `logic/`: 题型识别、学习/测试逻辑、输入模拟
- `overlay/`: 悬浮窗服务与控制面板
- `log/`: 日志管理与流式输出
- `debug/`: 调试辅助（节点导出等）
- `config/`: 目标应用/常量/开关
- `.local/`: 开发时创建的临时文件（自行创建此目录，该目录不会被上传至git仓库）
- UI 根：`MainActivity` + Compose 界面

资源与配置：
- `res/xml/`: 无障碍服务配置（如 `accessibility_service_config.xml`）
- `res/values/`: 字符串、颜色、主题等
- `AndroidManifest.xml`: 权限、服务、活动声明

---

## 2. 开发环境与构建

- JDK 17（与 `compileOptions`/`kotlinOptions` 对齐）
- Gradle Wrapper（勿全局替换 wrapper 版本）
- Android Gradle Plugin: 与 `app/build.gradle.kts` 中版本对齐
- 最低/目标 SDK: minSdk=28, targetSdk=34, compileSdk=34

构建与打包：
- 调试构建：Android Studio 直接运行或 Gradle 任务
- 发布打包：使用项目根目录脚本
  ```bash
  .\package.bat release
  # 输出：app/release/AutoSwapEng-signed.apk
  ```

签名配置：
- 本地填写 `package.env`（勿提交到仓库），自行填写 `ANDROID_SDK_ROOT`/`ANDROID_HOME`，其余信息如有遗漏可自行补充
- 仓库不存储任何明文密钥，避免硬编码凭据

---

## 3. 分支与发布

分支策略（简化）：
- `main`: 可发布稳定分支
- 功能分支：`feat/<module>-<short>`（示例：`feat/ocr-rate-limit`）
- 修复分支：`fix/<scope>-<short>`（示例：`fix/accessibility-crash`）
- 其他：`chore/*`、`refactor/*`、`perf/*`、`docs/*`

发布与版本：
- 版本号遵循 `SemVer`（与 `versionName` 对齐），`versionCode` 单调递增
- 打标签：`vX.Y.Z`（示例：`v0.2.1`）
- 变更记录：在 `docs/` 下维护版本更新说明（参考现有 `v0.2.0更新说明.md`）

---

## 4. 提交规范（Conventional Commits）

格式：
```
<type>(<scope>): <subject>

[optional body]
[optional footer]
```

常用 type：`feat` | `fix` | `docs` | `style` | `refactor` | `perf` | `test` | `build` | `ci` | `chore` | `revert`

示例：
```
feat(ocr): add Chinese/Latin text recognition with throttling
fix(accessibility): avoid NPE when root window is null
```

规则：
- `subject` 用简练中文或英文描述完成的变更（不以句号结尾）
- 单次提交聚焦单一主题；重构与功能改动勿混提

---

## 5. Kotlin/Compose 代码规范

通用：
- 遵循 Kotlin 官方代码风格（与 `kotlin.code.style=official` 保持一致）
- 优先使用**早返回**与**小函数**，避免深层嵌套
- 避免无意义注释；仅保留关键、不易从代码直接看出的信息
- 严禁在主线程执行耗时操作；OCR、节点遍历等在 `Dispatchers.Default/IO` 执行

命名：
- 函数：动词/动宾短语；变量：名词/名词短语；避免缩写
- 文件与类名表达意图；按功能与层次放置在对应包

错误处理：
- 仅在必要路径捕获异常；禁止空 `catch`
- 为可恢复错误提供清晰返回值或 Result 封装；不可恢复错误早失败+日志

协程：
- Service 范围内使用 `serviceScope + SupervisorJob`
- 控制并发数量与生命周期，避免泄漏与内存暴涨
- 明确指定调度器，跨线程切换用 `withContext`

Compose：
- UI 状态上提（State hoisting），不可变参数优先
- 稳定参数（`@Stable`/数据类）与 `remember` 合理使用，减少重组
- Material 3 主题统一；颜色/字符串从资源获取，避免硬编码
- 可访问性：提供 `semantics`/`contentDescription`，保证无障碍可读

依赖管理：
- 使用 Compose BOM（统一版本），避免 `+` 动态版本
- 新依赖需评估体积/许可/维护活跃度

---

## 6. 无障碍与 OCR 约定

无障碍（Accessibility）：
- 仅在必要时触发节点操作，避免高频遍历导致卡顿
- 节点查询与点击封装工具化，统一入口便于监控与调试

OCR：
- 统一通过 `ScreenCaptureHelper` 获取图像数据
- 控制识别频率（节流/去抖），避免占满 CPU/GPU
- 复用 ML Kit 客户端；错误时快速失败并退避重试

前台服务：
- OCR/录屏相关能力启动前必须确保前台服务已就绪
- 清晰状态机：准备中/就绪/失败，避免半初始化状态

---

## 7. 日志规范

- 统一使用 `LogManager`，按级别输出：DEBUG/INFO/WARN/ERROR
- 默认 INFO；仅在调试阶段开启 DEBUG，发布前降级
- 日志信息可用于问题定位，但禁止输出隐私数据与密钥
- 建议实现最大文件大小与轮转（若后续加入文件日志）

---

## 8. 资源与命名

- 字符串：`snake_case`，按使用域分组（如 `accessibility_*`, `ocr_*`）
- 颜色/主题：坚持 Material 3；暗色/动态色遵循系统策略
- XML 配置：文件名表达用途（`accessibility_service_config.xml`）
- Compose 组件：可复用组件放入 `ui/components`（后续引入时遵循）

---

## 9. 权限与安全

- 仅在需要时请求权限（无障碍、悬浮窗、前台服务、通知）
- Android 13+ 通知权限单独请求；存储权限仅对 <= 32 有效
- 所有密钥/路径放入环境或本地未跟踪文件（如 `package.env`）
- 严禁在仓库中提交任何凭证、签名文件密码等敏感信息

---

## 10. 测试与质量

- 基线：关键逻辑（题型识别、匹配算法、区域换算）具备单元测试
- UI：Compose 测试（可按需补充），确保基本可用性与语义标签
- Lint：保持 `abortOnError = true`，修复告警后再合并

PR 检查清单（最少）：
1) 代码通过构建与基本运行
2) 无明显 UI 卡顿/ANR/泄漏风险
3) 无硬编码文案/颜色/尺寸
4) 日志级别与内容审查通过
5) 权限请求与降级路径清晰
6) 变更说明与文档同步更新

---

## 11. 文档与变更记录

- 根目录 `README.md`：快速开始与主要能力
- `docs/项目开发规范.md`：本规范，随实践迭代
- `docs/*更新说明.md`：版本变更记录（与 Tag 对应）
- 如需新增专题文档，优先合并到现有文档，避免散乱

---

## 12. 常见问题（FAQ）

- 构建失败（JDK/AGP 版本不匹配）：确认使用 JDK 17 与项目约定版本
- 发布包未生成：确保执行 `.\package.bat release` 且签名环境变量可用
- 无障碍/录屏不可用：确认三项权限（无障碍、悬浮窗、屏幕录制）全部授予

---

## 13. 变更与执行

- 本规范为“活文档”，随版本演进更新；重大调整需经评审后合入
- 新贡献者在首次 PR 请附带自检清单勾选项


