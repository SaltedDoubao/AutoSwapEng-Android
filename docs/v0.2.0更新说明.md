# v0.2.0 更新说明

## 🎉 主要新功能

### 1. 悬浮窗控制面板

新增了一个功能强大的悬浮窗，提供更便捷的控制方式：

**特性：**
- ✨ 流畅的展开/收起动画（Spring弹性动画）
- 📊 实时显示服务状态
- 📈 显示已学习单词数量
- 🎛️ 一键切换学习/测试模式
- 🎨 Material Design 3 风格
- 📍 可拖动到任意位置

**使用方法：**
1. 在主界面点击"启动悬浮窗"
2. 悬浮窗会显示在屏幕右侧
3. 点击主按钮展开菜单
4. 长按可拖动位置

### 2. 完整的学习-测试流程

实现了与Python版本一致的核心逻辑：

#### 学习模式（Learning Mode）
- 自动识别单词和中文释义
- 解析词性标记（v., n., adj., adv., vt., vi., v.&n.等）
- 存储到内存中供后续测试使用
- 点击继续并自动滑动到下一题

#### 测试模式（Test Mode）
- 读取题目单词
- 从已学内容中查找对应释义
- 识别4个选项
- 使用模糊匹配算法计算相似度
- 自动点击最佳答案
- 自动滑动到下一题

**核心算法：**
- 贪心词性识别（优先匹配最长词性）
- Levenshtein编辑距离计算相似度（0-100分）
- 高度匹配（>=98分）额外加权1000分
- 确保最佳答案优先被选中

### 3. 模式切换智能处理

程序会根据页面内容智能判断：

**页面类型识别：**
- 有4个选项 → 测试页面
- 无选项 → 学习页面

**不同模式的响应：**

| 页面类型 | 学习模式行为 | 测试模式行为 |
|---------|------------|------------|
| 学习页面 | 记录单词+释义，点击继续 | 记录单词+释义，点击继续 |
| 测试页面 | 点击继续，跳过答题 | 自动选择最佳答案 |

这样设计的好处：
- 学习模式下不会误答题
- 两种模式都会学习新单词
- 测试模式下充分利用已学内容

## 🔧 技术改进

### 1. 代码架构优化

```
app/
├── accessibility/        # 无障碍服务
│   ├── AppAccessibilityService.kt  # 主服务（新增模式控制）
│   ├── NodeUtils.kt                 # 节点工具
│   └── ScreenCaptureHelper.kt      # OCR辅助（新增）
├── overlay/             # 悬浮窗（新增）
│   └── FloatingWindowService.kt    
├── logic/               # 核心算法
│   ├── WordMatcher.kt              # 匹配算法（新增getLearnedCount）
│   └── Regions.kt                  # 屏幕区域定义
├── ocr/                 # OCR引擎
│   └── OcrEngine.kt
└── config/              # 配置（新增）
    └── TargetApps.kt               # 目标应用配置
```

### 2. 新增API

**AppAccessibilityService：**
```kotlin
// 模式控制
fun setTestMode(testMode: Boolean)      // 设置测试模式
fun isTestMode(): Boolean                // 获取当前模式
fun getLearnedCount(): Int               // 获取学习数量

// 原有API
fun setEnabled(enabled: Boolean)
fun isEnabled(): Boolean
fun isRunning(): Boolean
```

**WordMatcher：**
```kotlin
fun getLearnedCount(): Int  // 新增：获取已学单词数量
fun learn(word, definitions)
fun match(word, options): Int
```

### 3. UI/UX改进

**动画效果：**
- 菜单展开：`fadeIn + expandVertically` + Spring动画
- 菜单收起：`fadeOut + shrinkVertically`
- FAB旋转：点击时旋转135度（变成×号）
- 状态切换：颜色平滑过渡

**视觉反馈：**
- 服务运行中：绿色主题色
- 服务未运行：灰色
- 学习模式：次要色（Teal）
- 测试模式：主要色（Purple）
- 按钮状态：自动禁用不可用选项

## 📱 使用流程示例

### 首次使用

```
1. 打开 AutoSwapEng
2. 点击"打开无障碍设置" → 启用服务
3. 点击"授权悬浮窗" → 授权权限
4. 点击"启动悬浮窗"
5. 打开扇贝单词/百词斩
6. 在悬浮窗中确认"学习模式"已开启
7. 开始学习，程序会自动记录单词
```

### 学习一段时间后

```
1. 点击悬浮窗主按钮
2. 切换"模式"开关到"测试模式"
3. 继续答题，程序会自动答题
4. 查看"已学习"计数确认学习进度
```

## 🐛 修复的问题

1. ✅ 修复学习逻辑不完整的问题
2. ✅ 修复模式切换不生效的问题
3. ✅ 修复悬浮窗权限请求问题

## ⚡ 性能优化

1. 悬浮窗状态更新间隔：500ms（避免过度刷新）
2. 防抖机制：500ms（避免重复处理）
3. 异步处理：所有耗时操作使用协程
4. 内存管理：正确释放服务资源

## 📊 与Python版本的对比

| 功能 | Python版本 | Android版本 v0.2.0 |
|-----|-----------|-------------------|
| 屏幕截图 | ✅ pyautogui | ⚠️ 需用户授权MediaProjection |
| OCR识别 | ✅ PaddleOCR | ✅ ML Kit (中英文) |
| 文本提取 | 截图+OCR | ✅ 无障碍节点（更快更准） |
| 词性解析 | ✅ 贪心算法 | ✅ 完全一致 |
| 模糊匹配 | ✅ fuzzywuzzy | ✅ Levenshtein算法 |
| 学习模式 | ✅ | ✅ |
| 测试模式 | ✅ | ✅ |
| 控制界面 | ❌ 命令行 | ✅ 悬浮窗GUI |
| 适配性 | 固定坐标 | ✅ 归一化坐标 |

## 🎯 下一步计划

1. **媒体投影集成**
   - 完整实现屏幕截图功能
   - 用于无障碍节点无法获取文本的场景

2. **数据持久化**
   - 保存学习记录到本地
   - 支持导入/导出词库

3. **更多应用支持**
   - 不背单词
   - 墨墨背单词
   - 知米背单词

4. **智能适配**
   - 自动检测屏幕区域
   - 支持不同分辨率

## 💡 使用建议

1. **首次使用建议在学习模式下观察几题**，了解程序如何工作
2. **学习10-20个单词后再切换测试模式**，效果更好
3. **定期切回学习模式**，补充新单词到词库
4. **遇到识别错误**，可能是OCR问题，尝试重新学习该单词

## 📝 已知限制

1. 屏幕截图需要用户授权（暂未实现）
2. 只支持扇贝单词和百词斩
3. 学习记录在应用重启后清空（暂无持久化）
4. 屏幕坐标基于固定比例（可能需要微调）

---

**详细的算法说明**请参考：`.local/program_logic_explanation.md`

**问题反馈**请提供：Android版本、设备型号、使用的学习应用、具体问题描述

